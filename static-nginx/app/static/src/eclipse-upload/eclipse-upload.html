<!--
Copyright 2017 Google Inc.
Licensed under the Apache License, Version 2.0 (the "License");

you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/i18n-format/i18n-format.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../behaviors/eclipse-debug-logger.html">
<link rel="import" href="../behaviors/eclipse-date-aware-behavior.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="eclipse-upload-file-preview.html">
<script src="../../bower_components/js-sha256/src/sha256.js"></script>
<script src="../array-findindex-polyfill.js"></script>
<dom-module id="eclipse-upload">
  <template>
    <style include="shared-styles">
      :host {

      }

      #content {
        background-color: #3f87ff;
        min-height: 205px;
        @apply(--layout-vertical);
        @apply(--paper-font-body2);
        color: var(--paper-grey-50);
        display:flex;
      }

      h2 {
        @apply(--paper-font-display1);
      }

      #license {
        @apply(--layout-vertical-reverse);
      }

      #license div.license-controls {
        @apply(--layout-flex-2);
        padding-left:32px;
        padding-right:32px;
        padding-bottom:32px;
      }

      #license div.img-holder {
        @apply(--layout-flex);
        min-width: 200px;
        padding: 16px;
      }

      .img-holder img {
        width: 100%;
        height:auto;
      }

      #license paper-button[disabled] {
        background: var(--paper-grey-400);
      }

      paper-button {
        background-color : var(--paper-yellow-600);
        color: var(--paper-grey-800);
      }

      /* This is sad, but due to style expansion on non Chrome browsers, need to define this style
         at the same level as paper-button, or else disabling doesn't work. */
      paper-button[disabled] {
        background-color: rgb(234, 234, 234);
        color: #a8a8a8;
      }

      paper-button.cancel {
        background: var(--paper-red-400);
      }

      #license paper-checkbox {
        margin-bottom:8px;
      }

      #license paper-button {
        @apply(--layout-self-start);
        margin-bottom:16px;
      }

      paper-checkbox {
        --primary-text-color: var(--paper-grey-50);
        --primary-color: var(--paper-yellow-600);
        --paper-checkbox-checkmark-color: var(--paper-grey-800);
      }

      vaadin-upload {
        @apply(--layout-vertical);
        margin:8px;
        min-height: 460px;
        --primary-color: var(--paper-yellow-600);
        --primary-font-color: var(--paper-grey-800);
        --vaadin-upload-buttons: {
          padding-top: 24px;
          padding-bottom:12px;
        }
        --vaadin-upload-buttons-primary:  {
          @apply(--layout-vertical);
          @apply(--layout-center);
          @apply(--layout-self-center);
          min-height:90px;
        }
      }

      vaadin-upload .drop-label {
        color: var(--paper-grey-50);
        @apply(--layout-vertical);
        margin-top:16px;
      }

      vaadin-upload .file-list {
      }

      vaadin-upload .file-list iron-list {
        height:400px;
      }

      .drop-label-instructions, .reset-label {
        @apply(--layout-center);
        @apply(--layout-self-center);
      }

      a:hover {
        text-decoration:underline;
      }
      a {
        text-decoration:none;
        color: var(--paper-yellow-500);
      }

      #confirm {
        height:205px;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
      }

      .complete-label {
        padding: 8px 16px;
      }

      .confirm-controls {
        padding:8px;
      }

      .confirm-controls div.controls {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .controls paper-checkbox {
        @apply(--layout-flex);
        margin-left:8px;
      }

      .controls-advanced {
        margin-top: 16px;
        padding: 8px;
        border-top: 1px dashed #dbdbdb;
      }

      .controls-advanced div.title {
        @apply(--paper-font-caption);
        margin-bottom: 4px;
      }

      @media all and (min-width:600px) {
        #license {
          @apply(--layout-horizontal);
          @apply(--layout-center);
          @apply(--layout-wrap);
        }

        #license div.img-holder {
          @apply(--layout-flex);
          min-width: 200px;
          overflow:hidden;
        }

        .img-holder img {
          width: 150%;
        }
      }
    </style>
    <app-location id="urlbar" route="{{route}}" query-params="{{queryParams}}"></app-location>
    <iron-pages
        id="content"
        attr-for-selected="id"
        fallback-selection="license"
        role="main"
        >
        <div id="license">
          <div class="license-controls">
            <h2>Upload eclipse photos!</h2>
            <paper-button raised disabled$="{{!_canProceed(licenseAgreeChecked, publicAgreeChecked)}}" on-tap="_showUpload">Start</paper-button>
            <paper-checkbox id="licenseAgree" checked="{{licenseAgreeChecked}}">I verify that I own these photos and am licensing them under the <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" on-tap="_licenseClick">CC0 license.</a></paper-checkbox>
            <paper-checkbox id="publicAgree" checked="{{publicAgreeChecked}}">I acknowledge that my name, these photos, and their locations will be part of a public database as per the <a href="/faq#photos_licenses" on-tap="_licenseClick">FAQ page</a>.</paper-checkbox>
          </div>
          <div class="img-holder"><img src="/images/profile_header-01.png"/></div>
        </div>
        <div id="upload-container">
          <vaadin-upload
              id="upload"
              target="/services/upload/"
              method="POST"
              files="{{files}}"
              accept="image/*, .3fr, .ari, .arw, .bay, .crw, .cr2, .cap, .data, .dcs, .dcr, .dng, .drf, .eip, .erf, .fff, .gpr, .k25, .kdc, .mdc, .mef, .mos, .mrw, .nef, .nrw, .obm, .orf, .pef, .ptx, .pxn, .r3d, .raf, .raw, .rwl, .rw2, .rwz, .sr2, .srf, .srw, .tif, .x3f"
              max-file-size="100000000"
          >
            <div class="drop-label">
              <div class="drop-label-instructions"><iron-icon icon="cloud-upload"></iron-icon>Drop eclipse photos here or click upload to select</div>
            </div>
            <div class="file-list">
              <iron-list items="[[files]]" as="item">
              <template>
                <eclipse-upload-file-preview index="[[index]]" file="[[item]]"></eclipse-upload-file-preview>
              </template>
              </iron-list>
            </div>
          </vaadin-upload>
          <div class="complete-label" hidden$="{{!completeCount}}">
            <i18n-format>
              <json-data>{
                "one": {
                "0" : "Uploaded {3} file successfully but no GPS info detected.  GPS data is necessary for the Megamovie and helpful for future scientific research. Methods of providing GPS info are detailed in the {4}.",
                "other": "Uploaded {3} file successfully and GPS info detected."
                },
                "other": {
                "0" : "Uploaded {3} files successfully but no GPS info detected. GPS data is necessary for the Megamovie and helpful for future scientific research. Methods of providing GPS info are detailed in the {4}.",
                "other" : "Uploaded {3} files successfully and GPS info detected."
                }
                }
              </json-data>
              <i18n-number>{{completeCount}}</i18n-number>
              <i18n-number>{{gpsCount}}</i18n-number>
              <span>{{completeCount}}</span>
              <a href="/faq" target="_blank">FAQ</a>
            </i18n-format>
          </div>
          <div class="error-label" hidden$="{{!errorCount}}">
            <i18n-format>
              <json-data>{
                "one": "{1} file had an error.",
                "other": "{1} files had an error."
                }
              </json-data>
              <i18n-number>{{errorCount}}</i18n-number>
              <span>{{errorCount}}</span>
            </i18n-format>
          </div>
          <div class="confirm-controls" hidden$="{{!completeCount}}">
            <div class="controls">
              <paper-button on-tap="_submit" disabled$="{{!_allowSubmit(files, submitCount)}}">Submit selected photos</paper-button>
              <paper-checkbox id="anonymous_photo">Don't include my name in the public database
                <sup><a name="anonymous_photo" on-tap="_showTooltip">?</a></sup>
              </paper-checkbox>
              <paper-tooltip for="anonymous_photo">By default, all images submitted will have your name ([[name]]) embedded into the EXIF data. By checking this box, we will not embed your name into these files.</paper-tooltip>
              <paper-button class="cancel" on-tap="_checkReset">Cancel</paper-button>
            </div>
            <div class="controls-advanced">
              <div class="title">Advanced options</div>
              <paper-checkbox id="equatorial_mount">These photos were taken with an equatorial mount
                <sup><a name="equatorial_mount" on-tap="_showTooltip">?</a></sup>
              </paper-checkbox>
              <paper-tooltip for="equatorial_mount">Only check this box if all of the photos were taken with an equatorial mount. If you have a mixture of photos, please submit them in separate batches.</paper-tooltip>
            </div>
          </div>
          <paper-toast id="toast" text="Error submitting."></paper-toast>
        </div>
      <div id="confirm">
        <div>Thank you for contributing to the Eclipse Megamovie!</div>
        <paper-button on-tap="_showLicense">Upload more files</paper-button>
      </div>
    </iron-pages>

    <iron-ajax
        id="photoConfirm"
        params='{}'
        handle-as="json"
        method="POST"
        on-response="_handleConfirmResponse"
        on-error="_handleConfirmError"
        debounce-duration="100"></iron-ajax>
  </template>
  <script>
      Polymer({
        is: 'eclipse-upload',
        behaviors: [EclipseBehaviors.DebugLoggerBehavior, EclipseBehaviors.DateAwareBehavior],

        properties: {
          user : {
            type: Object,
            notify: true,
            observer: '_onUserChanged'
          },
          roles : {
            type: Array
          },
          name : {
            type: String
          },
          totalCount: {
            type: Number,
            value: 0
          },
          completeCount: {
            type: Number,
            value: 0
          },
          gpsCount: {
            type: Number,
            value: 0
          },
          errorCount: {
            type: Number,
            value: 0
          },
          submitCount: {
            type: Number,
            value: 0
          },
          lackingGpsWarningText: {
            type: String,
            value: "We do not detect a GPS location in these files. GPS data is necessary for the Megamovie and helpful for future scientific research. Methods of providing GPS info are detailed in the FAQ. Press OK to submit without GPS."
          },
          confirmWarningText: {
            type: String,
            value: "Are you sure you want to cancel this session? These photos will be discarded."
          },
          unsubmittedPhotosWarningText: {
            type: String,
            value: "Please submit your photos or else they will be discarded."
          },
          uploadsInProgress: {
            type: Array,
            value: []
          },
          queuedRequests: {
            type: Array,
            value: []
          },
          maxFilesAtOnce: {
            type: Number,
            value: 1
          }
        },

        observers: [
          '_onUserChanged(user)',
          '_onFileChanged(files.*)'
        ],

        listeners: {
          'file-submit-changed' : '_onFileSubmitChanged'
        },

        attached: function() {
          if (this.LOCAL_DEBUG) {

            this.$.upload.target = "https://localhost/services/upload/";
          }
          this.consoleLogIfAble("Upload target = " + this.$.upload.target);

          this.listen(this.$.upload, "upload-before", "_onUploadBefore");
          this.listen(this.$.upload, "upload-start", "_onUploadStart");
          this.listen(this.$.upload, "upload-error", "_onUploadError");
          this.listen(this.$.upload, "upload-abort", "_onUploadAbort");
          this.listen(this.$.upload, "upload-response", "_onUploadResponse");
          this.listen(this.$.upload, "upload-success", "_onUploadSuccess");
        },

        detached: function() {
          this.unlisten(this.$.upload, "upload-before", "_onUploadBefore");
          this.unlisten(this.$.upload, "upload-start", "_onUploadStart");
          this.unlisten(this.$.upload, "upload-error", "_onUploadError");
          this.unlisten(this.$.upload, "upload-abort", "_onUploadAbort");
          this.unlisten(this.$.upload, "upload-response", "_onUploadResponse");
          this.unlisten(this.$.upload, "upload-success", "_onUploadSuccess");
        },

        isLackingGps: function() {
          return this.completeCount > 0 && this.gpsCount === 0;
        },

        hasUnsubmittedPhotos: function() {
          return this.completeCount > 0 && this.$.content.selected != "confirm";
        },

        _updateSessionId: function() {
          if (this.user) {
            var profile = this.user.getBasicProfile();
            var userId = profile.getId();
            // Make this a string by concatenating the user ID to the date.
            var sessionId = sha256(Date.now() + userId);
            this.$.upload.headers["X-UPLOADSESSIONID"] = sessionId;
            return sessionId;
          }
          return '';
        },

        _onUserChanged: function(user) {
          var sessionId;
          if (user) {
            var profile = user.getBasicProfile();
            sessionId = this._updateSessionId();
            this.$.upload.headers["X-IDTOKEN"] = user.getAuthResponse().id_token;
            this.$.upload.headers["Accept"] = "application/json";
            this.$.photoConfirm.headers["X-IDTOKEN"] = this.$.upload.headers["X-IDTOKEN"];
            this.$.photoConfirm.headers["X-UPLOADSESSIONID"] = this.$.upload.headers["X-UPLOADSESSIONID"];
            this.$.photoConfirm.url = this._getEndpointUrl();
            this.name = profile.getName();
          } else {
            this.$.upload.headers["X-IDTOKEN"] = null;
            this.$.upload.headers["X-UPLOADSESSIONID"] = null;
            this.$.photoConfirm.headers["X-IDTOKEN"] = null;
            this.$.photoConfirm.headers["X-UPLOADSESSIONID"] = null;
            this.$.photoConfirm.url = null;
            this.name = "";
            this._showLicense();
          }
          this.consoleLogIfAble("Set ID Token = " + this.$.upload.headers["X-IDTOKEN"] +
              " session id " + sessionId);
        },

        _getImageBucket: function(roles) {
          if (this.eclipseState == this.PRE_ECLIPSE_DAY) {
            if (roles.includes("volunteer")) {
              return "volunteer_test";
            }
          } else if (this.eclipseState == this.ECLIPSE_DAY
              || this.eclipseState == this.POST_ECLIPSE_DAY) {
            if (roles.includes("volunteer")) {
              return "megamovie";
            } else {
              return "teramovie";
            }
          }
        },

        _canProceed: function(licenseAgree, publicAgree) {
          return licenseAgree && publicAgree;
        },

        _showLicense: function() {
          // Send the user back to the license page and reset the checkbox.
          this.$.content.selected = "license";
          this.$.licenseAgree.checked = false;
          this.$.publicAgree.checked = false;
          this._resetCounters();
          this._updateSessionId();
        },

        _showUpload: function() {
          this.$.content.selected = "upload-container";
          this.$.upload.files = [];
          this._resetCounters();
        },

        _resetCounters: function() {
          this.completeCount = undefined;
          this.gpsCount = undefined;
          this.errorCount = undefined;
          this.totalCount = undefined;
          this.submitCount = undefined;
        },

        _onUploadBefore: function(event) {
          if (event.detail.file) {
            var file = event.detail.file;
            file.submit = true;

            this.$.upload.headers["X-CC0-AGREE"] = this.licenseAgreeChecked;
            this.$.upload.headers["X-PUBLIC-AGREE"] = this.publicAgreeChecked;
            this.$.upload.headers["X-IMAGE-BUCKET"] = this._getImageBucket(this.roles);
            if (this.user) {
              // Make sure we have a fresh refresh token.
              this.$.upload.headers["X-IDTOKEN"] = this.user.getAuthResponse().id_token;
            }
            // Queue if necessary.
            if (this.uploadsInProgress.length >= this.maxFilesAtOnce) {
              this.push('queuedRequests', event.detail);
              file.status = "Queued for upload"
              event.preventDefault();
              this.consoleLogIfAble("Queuing" + event.detail.file.name);
            } else {
              this.push('uploadsInProgress', event.detail);
              this.consoleLogIfAble("Pushed " + event.detail.file.name);
            }
          }
        },

        _onUploadStart: function(event) {
          // This needs to be set after the XHR is opened.
          if (event.detail.xhr) {
            event.detail.xhr.responseType = "json";
          }
        },

        _onUploadError: function(event) {
          this.consoleLogIfAble("Upload error: " + event.detail.file.name);
          this._processNextFile(event.detail.file);
        },

        _onUploadAbort: function(event) {
          this.consoleLogIfAble("Upload abort: " + event.detail.file.name);
          this._processNextFile(event.detail.file);
        },

        _onUploadResponse: function(event) {
          // Parse response, looking to see if GPS information is there.
          this.consoleLogIfAble("Got response. " + event.detail.xhr.response);
          if (event.detail && event.detail.xhr && event.detail.xhr.response) {
            var response = event.detail.xhr.response;
            // check the response type: IE11 for example doesn't support it.
            if (typeof response === 'string' || response instanceof String) {
              try {
                response = JSON.parse(response);
              } catch (ex) {
                response = {};
              }
            }
            if (response.lat && response.lon) {
              event.detail.file.gpsLocation = {latitude: response.lat, longitude: response.lon};
            }
            // Notify iron list it needs to refresh.
            this.$$("iron-list").notifyResize();
          };
        },

        _onUploadSuccess: function(event) {
          this.consoleLogIfAble("Upload success: " + event.detail.file.name);
          this._processNextFile(event.detail.file);
        },

        _processNextFile: function(fileDone) {
          // First remove from uploads in progress.
          var index = this.uploadsInProgress.findIndex(function(upload) {
            return upload.file === fileDone;
          });
          if (index != -1) {
            this.splice('uploadsInProgress', index, 1);
          }
          // Find next queued request.
          if (this.queuedRequests.length > 0) {
            var request = this.pop('queuedRequests');
            this.consoleLogIfAble("Sending " + request.file.name);
            // Call this after a yield.
            setTimeout(function() {this._uploadFileFromQueue(request)}.bind(this), 10);
          }
        },

        _uploadFileFromQueue: function(request) {
          // Taken largely from vaadin-upload: we want to hijack the upload process
          // in the upload-before event, so we need to call everything else in the
          // sequence manually here.
          var formData = new FormData();
          var file = request.file;
          var xhr = request.xhr;
          formData.append(file.formDataName, file, file.name);

          xhr.open(this.$.upload.method, file.uploadTarget, true);
          xhr.responseType = "json";
          // Configure request with headers, refreshing the ID token if necessary.
          // @see this._configureXhr in vaadin-upload.
          this.$.upload.headers["X-IDTOKEN"] = this.user.getAuthResponse().id_token;
          for (var key in this.$.upload.headers) {
            xhr.setRequestHeader(key, this.$.upload.headers[key]);
          }
          if (this.$.upload.timeout) {
            xhr.timeout = this.$.upload.timeout;
          }

          file.status = this.$.upload.i18n.uploading.status.connecting;
          file.uploading = file.indeterminate = true;
          file.complete = file.abort = file.error = false;

          xhr.upload.onloadstart = function() {
            this.fire('upload-start', {file: file, xhr: xhr});
            // Notify changes in file.
            var p = 'files.' + this.files.indexOf(file) + '.';
            for (var i in file) {
              if (file.hasOwnProperty(i)) {
                this.notifyPath(p + i, file[i]);
              }
            }
            // Notify iron list it needs to refresh.
            this.$$("iron-list").notifyResize();
          }.bind(this);

          // Custom listener could modify the xhr just before sending it
          // preventing default
          var evt = this.fire('upload-request', {file: file, xhr: xhr, formData: formData}, {cancelable: true});
          if (!evt.defaultPrevented) {
            xhr.send(formData);
          }
        },

        _onFileChanged: function(changeRecord) {
          if (!changeRecord.path.endsWith("complete") &&
              !changeRecord.path.endsWith("gpsLocation") &&
              !changeRecord.path.endsWith("length") &&
              !changeRecord.path.endsWith("error") &&
              !changeRecord.path.endsWith("submit")) {
            // Only process changes that could affect total, error, complete or gps counts.
            return;
          }
          var files = changeRecord.base;
          this._computeFileCounts(files);
        },

        _computeFileCounts: function(files) {
          var length = files.length;
          var fileCompleteCount = 0;
          var gpsCount = 0;
          var fileErrorCount = 0;
          var submitCount = 0;
          for (var index  = 0; index < length; index++) {
            var file = files[index];
            if (file.complete) {
              fileCompleteCount++;
              if (file.gpsLocation) {
                gpsCount++;
              }
              if (file.submit) {
                submitCount++;
              }
            }
            if (file.error) {
              fileErrorCount++;
            }
          }
          this.completeCount = fileCompleteCount;
          this.gpsCount = gpsCount;
          this.errorCount = fileErrorCount;
          this.totalCount = length;
          this.submitCount = submitCount;
        },

        _onFileSubmitChanged: function(event) {
          var index = event.detail.index;
          var checked = event.detail.checked;
          this.files[index].submit = checked;
          // Refresh the list.
          this.$$("iron-list").notifyResize();
          // Refresh the button.
          this._computeFileCounts(this.files);
        },


        _licenseClick: function(event) {
          event.stopPropagation();
        },

        _submit: function() {
          if (this.isLackingGps()) {
            if (!confirm(this.lackingGpsWarningText)) {
              return;
            }
          }
          var photoConfirm = this.$.photoConfirm;
          var idToken = this.user.getAuthResponse().id_token;
          photoConfirm.headers = {"Content-Type" : "application/json",
                                  "X-IDTOKEN" : idToken};
          photoConfirm.url = this._getEndpointUrl();
          var filenames = [];
          var length = this.files.length;
          for (var index  = 0; index < length; index++) {
            var file = this.files[index];
            if (file.complete && file.submit) {
              filenames.push(file.name);
            }
          }
          if (filenames.length > 0) {
            photoConfirm.body = {filenames: filenames,
                upload_session_id: this.$.upload.headers["X-UPLOADSESSIONID"],
                anonymous_photo: this.$.anonymous_photo.checked,
                equatorial_mount: this.$.equatorial_mount.checked};
            photoConfirm.generateRequest();
          }
        },

        _checkReset: function() {
          if (confirm(this.confirmWarningText)) {
            // Clear the queue.
            var length = this.queuedRequests.length;
            this.splice('queuedRequests', 0, length);
            this._showLicense();
          }
        },

        _getEndpointUrl: function() {
          var url = "/services/photo/confirm";
          if (this.LOCAL_DEBUG) {
            url = "https://localhost" + url;
          }
          return url;
        },

        _handleConfirmResponse: function(e) {
          this._showConfirm();
        },

        _handleConfirmError: function(e) {
          var toast = this.$$("#toast");
          toast.fitInto = this.$$("#upload-container");
          if (toast.opened) {
            toast.close();
          }
          toast.open();
        },

        _showConfirm: function() {
          this.$.content.selected = "confirm";
        },

        _showTooltip: function(event) {
          var id = event.target.name;
          var tooltip = this.$$("paper-tooltip[for='"+id+"'");
          if (tooltip) {
            tooltip.show();
            event.stopPropagation();
          }
        },

        _allowSubmit: function(files, submitCount) {
          if (submitCount == 0) {
            return false;
          }
          // Check all the files: make sure none are in progress.
          var length = files.length;
          var fileCompleteCount = 0;
          var fileErrorCount = 0;
          for (var index  = 0; index < length; index++) {
            var file = files[index];
            if (file.complete) {
              fileCompleteCount++;
            }
            if (file.error) {
              fileErrorCount++;
            }
          }
          return fileCompleteCount + fileErrorCount == files.length;
        }
      });
    </script>
</dom-module>
