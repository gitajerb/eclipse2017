<!--
Copyright 2016 Google Inc.
Licensed under the Apache License, Version 2.0 (the "License");

you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="behaviors/eclipse-debug-logger.html">
<link rel="import" href="eclipse-form-section/eclipse-form-section.html">
<link rel="import" href="eclipse-section/eclipse-section.html">
<link rel="import" href="eclipse-text-box/eclipse-text-box.html">
<link rel="import" href="eclipse-certificate.html">
<link rel="import" href="shared-styles.html">
<script src="array-includes-polyfill.js"></script>
<script src="string-endswith-polyfill.js"></script>
<script src="client-id.js"></script>

<dom-module id="eclipse-profile">
  <template>
    <style include="shared-styles">
      :host {
        @apply(--layout-vertical);
        @apply(--content-width);
        @apply(--layout-flex);
        max-width:800px;
      }

      #profile, #apply, #volunteer, #signinprompt, #certificate {
        @apply(--layout-vertical);
      }

      #apply, #volunteer {
        margin: 8px 0;
      }

      #advanced {
        margin-bottom:8px;
      }

      eclipse-form-section {
        margin: 8px 0px;
      }

      .name-section {
        padding-top:16px;
      }

      .name-line {
        margin-bottom:16px;
      }

      .fieldlabel {
        width: 4em;
        margin-right: 16px;
        display: inline-block;
      }

      .moreinfo {
        margin-top:8px;
        @apply(--paper-font-caption);
      }

      google-signin {
        @apply(--layout-self-end);
        margin-top:24px;
        margin-bottom:8px;
      }

      .deleteButton {
        margin-top:6px;
        color: var(--paper-red-500);
      }

      .newsletter-header {
        margin-top:24px;
      }

      .newsletter-caption {
        margin-top:8px;
        margin-bottom:16px;
        @apply(--paper-font-caption);
      }

      paper-radio-button {
        margin-bottom: 8px;
      }

      #cameraField {
        margin-top:8px;
      }

      #cameraField h4 {
        margin: 4px 8px;
      }

      .camera-option {
        @apply(--layout-horizontal);
        @apply(--paper-font-body1);
        margin-left:8px;
      }

      .camera-option .img-holder {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        margin: 0 16px;
      }

      .img-holder img {
        width:85px;
      }

      .camera-text {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
      }

      .section-card  {
        color: var(--paper-grey-800);
        @apply(--layout-vertical);
        @apply(--paper-font-body1);
        padding:16px;
      }

      .section-card-header {
        margin-right:16px;
        @apply(--paper-font-subhead);
      }

      #profile-banner {
         background-image: url("/images/profile_header-01.png");
         background-position: right center;
         background-repeat: no-repeat;
         background-color: #3f87ff;
         background-size: auto 130%;
         margin: 8px 0px;
         min-height: 205px;
         @apply(--paper-font-display1);
         @apply(--layout-center);
         display:flex;
         padding:32px;
      }

      #profile-banner div {
        max-width:40%;
        white-space:normal;
      }

      #noprofile, #signinprompt {
        margin: 8px 0px;
      }

      h4 {
        @apply(--paper-font-subhead);
        margin:0;
      }

      .apply-button {
        text-decoration:none;
        background: var(--paper-teal-500);
        color: var(--paper-grey-50);
        @apply(--paper-font-body2);
        line-height:1.0;
        margin: 8px 0;
      }

      paper-button[disabled] {
        background: var(--paper-grey-400);
      }

      #apply-button-holder a:hover {
        text-decoration:none;
      }
      a:hover {
        text-decoration:underline;
      }
      a {
        text-decoration:none;
      }

      div[disabled] {
        color: var(--paper-grey-400);
      }

      eclipse-form-section {
        --secondary-summary-theme: {
          color: var(--paper-green-500);
        }
      }

      .apply-caption {
        @apply(--paper-font-caption);
        margin-bottom:16px;
      }

      #admin-card {
        padding: 16px 16px;
        margin: 0 24px;
        @apply(--layout-vertical);
      }

      #admin-card a {
        display: block;
      }

      @media all and (min-width:600px) {
        .section-card {
          @apply(--layout-horizontal);
        }

        #cameraField h4 {
          margin: 8px 8px;
        }

        .img-holder img {
          width:130px;
        }
      }

      @media all and (max-width:600px) {
        .camera-option {
          @apply(--layout-wrap);
        }
      }
    </style>

    <app-location id="urlbar" route="{{route}}" query-params="{{queryParams}}"></app-location>

    <google-signin
        id="signin"
        scopes="profile"
        raised="true"
        signed-in="{{signedIn}}"
        hidden$="{{!signedIn}}"
    ></google-signin>

    <template is="dom-if" if="{{!_hasBadges(signedIn, userService.roles, userService.badges)}}">
      <div id="profile-banner">
        <div>[[greeting]]</div>
      </div>
    </template>

    <template is="dom-if" if="{{!userService.exists}}">
      <div id="noprofile">
        <paper-card class="section-card">
          Thank you for your interest in the Eclipse Megamovie. We are no longer accepting uploads.
        </paper-card>
      </div>
    </template>

    <template is="dom-if" if="{{_hasBadges(signedIn, userService.roles, userService.badges)}}">
      <paper-card id="certificate">
        <eclipse-certificate name="[[userService.name]]" badges="[[userService.badges]]"></eclipse-certificate>
      </paper-card>
    </template>

    <!-- Eclipse profile page content -->
    <div id="profile" hidden$="{{!userService.exists}}">

      <eclipse-form-section id="profileSection"
                            label="Profile"
                            noactions
                            summary="{{_getProfileSummary(userService.email, userService.name)}}">
        <template is="dom-if" if="{{!userService.error}}">
          <div class="input-section name-section">
            <div class="name-line"><span class="fieldlabel">Name:</span><span class="fieldvalue">[[userService.name]]</span></div>
            <div><span class="fieldlabel">Email:</span><span class="fieldvalue">[[userService.email]]</span></div>
            <div class="moreinfo">This is the name and email address from your <a href="https://myaccount.google.com/privacy?pli=1#personalinfo" target="_blank">Google Account</a>. <a href="#" on-tap="_disconnect">Not you?</a></div>
            <div class="newsletter-header">Newsletter: <a href="https://groups.google.com/a/lists.berkeley.edu/forum/#!forum/eclipse" target="_blank">Join the UC Berkeley Eclipse Megamovie Google Group</a></div>
            <div class="newsletter-caption">To get email notifications about the eclipse and updates to this site.</div>
          </div>
        </template>
        <template is="dom-if" if="{{userService.error}}">
          <div class="input-section name-section">Could not access profile information.</div>
        </template>
      </eclipse-form-section>

      <div id="advanced" hidden$="{{!userService.exists}}">
        <eclipse-form-section label="Advanced" summary="" noactions>
          <paper-button class="deleteButton" on-tap="_confirmDelete">Delete account</paper-button>
        </eclipse-form-section>
      </div>

      <template is="dom-if" if="[[_checkSpecialPages(userService.roles)]]">
        <paper-card class="section-card" id="admin-card">
          <a href="/admin" hidden$="[[!_checkRole(userService.roles, 'admin')]]"><h4>Admin page</h4></a>
          <a href="/review" hidden$="[[!_checkRole(userService.roles, 'reviewer')]]"><h4>Photo review page</h4></a>
        </paper-card>
      </template>
    </div>

    <div id="signinprompt" hidden="{{signedIn}}">
      To view your profile, you need to sign in with a Google Account.
    </div>
  </template>

  <script>
    Polymer({
      is: 'eclipse-profile',
      behaviors: [EclipseBehaviors.DebugLoggerBehavior, EclipseBehaviors.DateAwareBehavior],

      properties: {
        userService : {
          type: Object
        },
        greeting : {
          type: String,
          value: "Eclipse Megamovie"
        },
        geocodedLocation: {
          type: Array
        }
      },

      observers: [
      ],

      attached: function() {
        var signin = this.$$("#signin");
        signin.setAttribute("client-id", client_id);
        this._refreshProfile();
        this._registerUserServiceListener();

        // Make a closure storing this Polymer object
        this.beforeUnload = function(profile) {
          function checkSaving(event) {
           return profile._checkNeedsSaving(event);
          };
          return checkSaving;
        }(this);

        window.addEventListener('beforeunload', this.beforeUnload);
        this.$.profileSection.opened = true;
      },

      detached: function() {
        this._unregisterUserServiceListener();
        window.removeEventListener('beforeunload', this.beforeUnload);
      },

      _registerUserServiceListener: function() {
        if (this.userService) {
          this.listen(this.userService, 'user-service-ready', '_onUserServiceReady');
        }
      },

      _unregisterUserServiceListener: function() {
        if (this.userService) {
          this.unlisten(this.userService, 'user-service-ready', '_onUserServiceReady');
        }
      },

      _onUserServiceReady: function() {
        this.consoleLogIfAble("user service ready");
        // Need to refresh the fields.
        this._refreshProfile();
      },

      _refreshProfile: function() {
        // Refresh the bound fields. TODO: this seems odd, perhaps there is a better way?
        var cache = this.userService;
        this.userService = null;
        this.userService = cache;
      },

      _disconnect: function() {
        this.userService.disconnect();
      },

      _getProfileSummary: function() {
        if (!this.userService) {
          return '';
        }
        var name = this.userService.name;
        var email = this.userService.email;
        var summary;
        if (name && email) {
          summary = name + " (" + email + ")";
        } else if (name) {
          summary = name;
        } else {
          summary = email;
        }
        return summary;
      },

      _getCameraSummary: function() {
        if (!this.userService) {
          return '';
        }
        var camera = this.userService.camera;
        var cameraOption = this.$$("paper-radio-button[name='" + camera + "']");
        if (cameraOption) {
          return cameraOption.querySelector("h4").innerHTML;
        }
        return '';
      },

      _getTotalityString: function() {
        if (this.totality) {
          return "(in totality)";
        } else {
          return '';
        }
      },

      // Return true if apply button should be shown.
      _checkApply: function() {
        return false;
      },

      // Return true if entire apply section should be shown.
      _checkApplySection: function(signedIn) {
        if (signedIn === false) {
          return false;
        } else if (this._checkVolunteer()) {
          // If already a volunteer, no reason to show this section.
          return false;
        } else {
          return true;
        }
      },

      _checkVolunteer: function(signedIn) {
        if (this.signedIn === false) {
          return false;
        }
        return (this.userService && this.userService.roles
            && this.userService.roles.includes("volunteer"));
      },

      _handleFormSave: function(event) {
        this.consoleLogIfAble("Saving.");
        var params = {};
        if (event.detail.formSection) {
          var label = event.detail.formSection.label;
          if (label == "Profile") {
            // TODO: handle in the UX the situation where user name changed in Google account but
            // we have old version.
            var profile = this.userService.user.getBasicProfile();
            params.name = profile.getName();
            params.email = profile.getEmail();
          } else if (label == "Location") {
            // No more map.
          } else if (label == "Camera") {
            // No more camera.
          }

          event.detail.formSection.opened = false;
          if (event.detail.formSection.nextElementSibling) {
            event.detail.formSection.nextElementSibling.opened = true;
          }

          if (!this.userService.exists) {
            // create a new user.
            // Fill in basic info from the profile so if this has changed, we get it.
            // Always send these when creating.
            var profile = this.userService.user.getBasicProfile();
            params.name = profile.getName();
            params.email = profile.getEmail();
            this.userService.createUser(params);
          } else {
            this.userService.updateUser(params);
          }

        }
      },

      _confirmDelete: function(event) {
        if (confirm("This will delete your account. Are you sure?")) {
          this.userService.deleteUser();
        }
      },

      _needsSaving: function() {
        return false;
      },

      _checkNeedsSaving: function(event) {
        var dialogText = '';
        var upload = this.$$('eclipse-upload');
        if (upload && upload.hasUnsubmittedPhotos()) {
          dialogText = upload.unsubmittedPhotosWarningText;
        } else if (this._needsSaving()) {
          dialogText = "You have unsaved changes.";
        }

        if (dialogText.length > 0) {
          event.returnValue = dialogText;
          // TODO: if we aren't on the page already, navigate here?
          return dialogText;
        }
      },

      _checkSpecialPages: function(roles) {
        return this._checkRole(roles, "admin") || this._checkRole(roles, "reviewer");
      },

      _checkRole: function(roles, role) {
        if (roles && roles.includes) {
          return roles.includes(role);
        }
        return false;
      },

      _hasBadges: function(signedIn, roles, badges) {
        return this._checkRole(roles, "volunteer") || (badges && badges.length > 0);
      },

      _getInfoPageSelection: function(eclipseState) {
        if (eclipseState == this.PRE_ECLIPSE_DAY) {
          return "pre";
        } else {
          return "dayAndPost";
        }
      }
    });
  </script>
</dom-module>
